# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id: Portfile 123374 2014-08-08 21:53:07Z mojca@macports.org $

PortSystem          1.0
PortGroup           github 1.0

github.setup        plumed plumed2 2.2.2 v
name                plumed
PortGroup           mpi 1.0

revision            1
categories          science
license             gpl
maintainers         gmail.com:giovanni.bussi
description         plumed
long_description    plumed
platforms           darwin

homepage            http://www.plumed.org/

checksums           rmd160  179832bc8a65a8eac0a7a21bdbc651dc95852d56 \
                    sha256  a5edf90c39ee99023ce323121d7c9824bc6796f9fdff2f25ef0b2ca0cc9220fe

# This is required so that patch made with "git format-patch" work correctly
patch.pre_args -p1
# These patches are required to incorporate the features needed for macports
# to work. They have been included upstream, so will not be necessary with
# next plumed release (2.2.3)
patchfiles patch-Added-disable-dependency-tracking-to-.-configure.diff \
           patch-Added-all_plus_docs-target.diff \
           patch-Added-mdroot-to-patch.diff \
           patch-Added-__PLUMED_DEFAULT_KERNEL.diff \
           patch-Fix-in-__PLUMED_DEFAULT_KERNEL.diff

# Disable additional features.
# they are then re-enabled when selecting proper variants
# this is important for features that require an additional package to be
# sure that even if the user has that package already installed plumed is
# not going to use it.
configure.args --disable-matheval \
               --disable-xdrfile \
               --disable-molfile-plugins \
               --disable-zlib \
               --disable-mpi

# Hardcode path for libplumedKernel.dylib.
# This allows to patch MD codes using the --runtime option but using as
# default kernel the installed one. In this way, MacPorts users
# can just use patched MD codes with the installed plumed or replace it
# by setting PLUMED_KERNEL at runtime
configure.cppflags-append "-D__PLUMED_DEFAULT_KERNEL=${prefix}/lib/libplumedKernel.dylib"

compilers.choose    cc cxx
mpi.setup

if {[mpi_variant_isset]} {
  configure.args-delete --disable-mpi
}

variant matheval description {Enable libmatheval} {
  configure.args-delete --disable-matheval
  depends_lib-append port:libmatheval
}

variant xdrfile description {Enable xdrfile} {
  configure.args-delete --disable-xdrfile
  depends_lib-append port:xdrfile
}

variant zlib description {Enable zlib} {
  configure.args-delete --disable-zlib
  depends_lib-append port:zlib
}

variant molfile description {Enable molfile} {
  configure.args-delete --disable-molfile-plugins
}

variant extra_modules description {Enable extra modules} {
  configure.args-append --enable-modules=crystallization:manyrestraints
}
 
variant debug description {Enable debug flags} {
  configure.args-append --enable-debug
}

variant doc description {Also compile documentation} {
  depends_build-append port:doxygen
  depends_build-append port:graphviz
  build.target all_plus_docs
}

default_variants +matheval +xdrfile +zlib

# This is required since PLUMED installation does not do it explicitly.
# It might be removed when this will be incorporated upstream
post-destroot {
    system "install_name_tool -id ${prefix}/lib/libplumed.dylib ${destroot}${prefix}/lib/libplumed.dylib"
    system "install_name_tool -id ${prefix}/lib/libplumedKernel.dylib ${destroot}${prefix}/lib/libplumedKernel.dylib"
}

